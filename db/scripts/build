#!/bin/bash
SCRIPTS=$(dirname $(readlink -f "$BASH_SOURCE"))
SRC=$(realpath "$SCRIPTS/../src")
OUTDIR=$(realpath "$SCRIPTS/../init")
OUT=$OUTDIR/schema.sql
eval "$(node $SCRIPTS/print-env.js)"

echo "generating script"

mkdir -p "$OUTDIR"
echo "-- GENERATED BY @postpub/schema AT $(date)" > $OUT

echo "\\set ON_ERROR_STOP true" >> $OUT
echo "select set_config('postpub.app_pass', '$APP_PASS', true);" >> $OUT

dirs=$(find "$SRC/" -mindepth 1 -type d | sort)
for dir in $dirs; do
  for file in $(find $dir -type f -name "*.sql" | sort); do
    rel=$(realpath --relative-to=$SRC $file)
    echo $rel
    echo "" >> $OUT
    echo "-- SOURCE: $rel" >> $OUT
    echo "" >> $OUT
    cat "$file" >> "$OUT"
  done
done
